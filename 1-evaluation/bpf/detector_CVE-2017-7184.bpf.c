#include "vmlinux.h"
#include <bpf/bpf_helpers.h>
#include <bpf/bpf_tracing.h>
#include <bpf/bpf_core_read.h>

u64 ret_xfrm_new_ae = 0xffffffff81bca503;

struct {
    __uint(type, BPF_MAP_TYPE_HASH);
    __uint(max_entries, 200);
    __type(key, u32); // pid
    __type(value, struct pt_regs); 
} checkpoints SEC(".maps");


SEC("kprobe/xfrm_new_ae")
int BPF_KPROBE(checkpoint_setup)
{
    u32 pid = bpf_get_current_pid_tgid();
    struct pt_regs x_regs = {};
        x_regs.r15 = ctx->r15 ;
        x_regs.r14 = ctx->r14 ;
        x_regs.r13 = ctx->r13 ;
        x_regs.r12 = ctx->r12 ;
        x_regs.bp  = ctx->bp  ;
        x_regs.bx  = ctx->bx  ;
        x_regs.r11 = ctx->r11;
        x_regs.r10 = ctx->r10;
        x_regs.r9  = ctx->r9 ;
        x_regs.r8  = ctx->r8 ;
        x_regs.ax  = ctx->ax ;
        x_regs.cx  = ctx->cx ;
        x_regs.dx  = ctx->dx ;
        x_regs.si  = ctx->si ;
        x_regs.di  = ctx->di ;
    x_regs.orig_ax = ctx->orig_ax;
        x_regs.ip = ctx->ip;
        x_regs.cs = ctx->cs;
        x_regs.flags = ctx->flags;
        x_regs.sp = ctx->sp;
        x_regs.ss = ctx->ss;
    int err = bpf_map_update_elem(&checkpoints, &pid, &x_regs, BPF_ANY);
    return 0;
}

SEC("kretprobe/xfrm_new_ae")
int BPF_KRETPROBE(checkpoint_remove)
{
    u32 pid = bpf_get_current_pid_tgid();
    struct pt_regs* pregs = bpf_map_lookup_elem(&checkpoints, &pid);
    if (pregs) {
        int err = bpf_map_delete_elem(&checkpoints, &pid);
    }
    return 0;
}

int restore(struct pt_regs *ctx, u64 errcode, u64 retaddr)
{
    int err = bpf_send_signal(9);// SIGKILL
    u32 pid = bpf_get_current_pid_tgid();
    struct pt_regs *px_regs = bpf_map_lookup_elem(&checkpoints, &pid);
    if (px_regs) {
        px_regs->ax = errcode;
        px_regs->ip = retaddr;
        err = bpf_set_regs(ctx, px_regs);
    }
    return 0;
}




// static int xfrm_new_ae(struct sk_buff *skb, struct nlmsghdr *nlh,
// 		struct nlattr **attrs)
// {
// 	struct net *net = sock_net(skb->sk);
// 	struct xfrm_state *x;
// 	int err = -EINVAL;
// 	u32 mark = 0;

// 	struct xfrm_aevent_id *p = nlmsg_data(nlh);
// 	struct nlattr *re = attrs[XFRMA_REPLAY_ESN_VAL];
// 	// …
// 	x = xfrm_state_lookup(net, mark, &p->sa_id.daddr, p->sa_id.spi, p->sa_id.proto, p->sa_id.family);
// 	// …

// 2323	err = xfrm_replay_verify_len(x->replay_esn, re);


// ---------------------------------------------------------


// static inline int xfrm_replay_verify_len(struct xfrm_replay_state_esn *replay_esn,
// 					 struct nlattr *rp)
// {
// 	struct xfrm_replay_state_esn *up;
// 	unsigned int ulen;
//     ...
// 434	up = nla_data(rp);

// 	// OOB bypassed relative checks
// 444	pr_info("oob: up->replay_window:0x%x, up->bmp_len:0x%x, (up->bmp_len * sizeof(__u32) * 8):0x%x\n", 
// 								up->replay_window, 
// 								up->bmp_len,
// 								(up->bmp_len * sizeof(__u32) * 8));  // ffffffff81d59820    ffffffff81d5983a
// 	// if (up->replay_window > up->bmp_len * sizeof(__u32) * 8)
// 	// 	return -EINVAL;

// ffffffff81d59820 <xfrm_new_ae.cold>:
// ffffffff81d59820:       44 89 c1                mov    %r8d,%ecx
// ffffffff81d59823:       41 8b 75 18             mov    0x18(%r13),%esi
// ffffffff81d59827:       44 89 c2                mov    %r8d,%edx
// ffffffff81d5982a:       48 c7 c7 30 82 55 82    mov    $0xffffffff82558230,%rdi
// ffffffff81d59831:       48 c1 e1 05             shl    $0x5,%rcx
// ffffffff81d59835:       e8 b9 89 fb ff          call   ffffffff81d121f3 <_printk>
// ffffffff81d5983a:       e9 23 ac e1 ff          jmp    ffffffff81b74462 <xfrm_new_ae+0x142>


// up: R13 + 4
// up->replay: 20 + 4(%r13):  0x18(%r13)
// up->bmp_len:  0x4(%r13)

// python -c 'print(hex(0xffffffff81d59835-0xffffffff81d59820))'
// python -c 'print(hex(0xffffffff81d5929e-0xffffffff81d59289))'
SEC("kprobe/xfrm_new_ae.cold+0x15")
int BPF_KRETPROBE(prog1)
{
    u64 up_bmp_len = 0;
    u64 up_replay = 0;
    u64 up = ctx->r13;
    u64 addr_up_bmp_len = up;
    u64 addr_up_replay = up + 0x18;
    bpf_core_read(&up_bmp_len, 8, addr_up_bmp_len);
    bpf_core_read(&up_replay, 8, addr_up_replay);
    // bpf_printk("param: up->bmp_len:0x%lx, up->replay:0x%lx\n", up_bmp_len, up_replay);
    // bpf_printk("printk rsi:0x%lx, rdx:0x%lx, rcx:0x%lx\n", ctx->si, ctx->dx, ctx->cx);
    int oob = (ctx->si != up_replay);
    if (oob) {
        bpf_printk("====CVE-2017-7184 integer overflow happens====\n");
        restore(ctx, 0xffffffffffffffea, ret_xfrm_new_ae);
    }
    return 0;
}


// net/xfrm/xfrm_replay.c

// 533 static void xfrm_replay_advance_esn(struct xfrm_state *x, __be32 net_seq)
// ...
// 579				replay_esn->bmp[nr] &=  ~(1U << bitnr);  //ffffffff81b946f8
// ...
// 584				replay_esn->bmp[i] = 0;
// ...
// 605	            replay_esn->bmp[nr] |= (1U << bitnr);

// ffffffff81b944d0 <xfrm_replay_advance>:
// ...
// ffffffff81b94720:       46 21 54 8b 18          and    %r10d,0x18(%rbx,%r9,4)
// ...
// ffffffff81b94790:       4c 8d 43 18             lea    0x18(%rbx),%r8
// ffffffff81b94794:       c1 e8 05                shr    $0x5,%eax
// ffffffff81b94797:       48 8d 44 83 1c          lea    0x1c(%rbx,%rax,4),%rax
// ffffffff81b9479c:       41 c7 00 00 00 00 00    movl   $0x0,(%r8)
// ffffffff81b947a3:       49 83 c0 04             add    $0x4,%r8
// ffffffff81b947a7:       4c 39 c0                cmp    %r8,%rax
// ffffffff81b947aa:       75 f0                   jne    ffffffff81b9479c <xfrm_replay_advance+0x2cc>
// ...
// ffffffff81b94776:       44 09 44 bb 18          or     %r8d,0x18(%rbx,%rdi,4)


// replay_esn->bmp: %rbx + 0x18   u32 bmp[]
// python -c 'print(hex(0xffffffff81b94720-0xffffffff81b944d0))'

// ffffffff81b397a0 <xfrm_replay_advance>:
// ...
// ffffffff81b399ac:       f7 d0                   not    %eax
// ffffffff81b399ae:       41 21 44 bd 18          and    %eax,0x18(%r13,%rdi,4)  // probe here
// ffffffff81b399b3:       41 39 f6                cmp    %esi,%r14d

// python -c 'print(hex(0xffffffff81b399ae-0xffffffff81b397a0))'
// SEC("kprobe/xfrm_replay_advance+0x20e")
// int BPF_KPROBE(prog2)
// {
//     // u64 rbx = ctx->bx;
//     // u64 addr_replay_esn_bmp = rbx + 0x18;
//     u64 rbx = ctx->r13;
//     u64 addr_replay_esn_bmp = rbx + 0x18;
//     u64 start_addr = bpf_get_slab_start(addr_replay_esn_bmp);
    
//     u64 buf_len = bpf_get_buff_len(addr_replay_esn_bmp);
//     u64 end_addr = start_addr + (u32)buf_len;
//     u64 addr_replay_esn_bmp_nr = addr_replay_esn_bmp + (ctx->r9) * 4;
//     int oob = addr_replay_esn_bmp_nr > end_addr;

//     bpf_printk("xfrm_replay_advance0: oob:%d\n", oob);
//     bpf_printk("xfrm_replay_advance: replay_esn->bmp[nr]:0x%lx, [0x%lx, 0x%lx)\n", addr_replay_esn_bmp_nr, start_addr, end_addr);
//     return 0;
// }

// python -c 'print(hex(0xffffffff81b9479c-0xffffffff81b944d0))'
// SEC("kprobe/xfrm_replay_advance+0x2cc")
// int BPF_KPROBE(prog3)
// {
//     u64 rbx = ctx->bx;
//     u64 addr_replay_esn_bmp = rbx + 0x18;
//     u64 start_addr = bpf_get_slab_start(addr_replay_esn_bmp);
//     u64 buf_len = bpf_get_buff_len(addr_replay_esn_bmp);
//     u64 end_addr = start_addr + (u32)buf_len;
//     u64 addr_replay_esn_bmp_i = ctx->r8;
//     int oob = addr_replay_esn_bmp_i > end_addr;

//     bpf_printk("xfrm_replay_advance1: oob:%d\n", oob);
//     bpf_printk("xfrm_replay_advance: replay_esn->bmp[i]:0x%lx, [0x%lx, 0x%lx)\n", addr_replay_esn_bmp_i, start_addr, end_addr);

//     return 0;
// }

// python -c 'print(hex(0xffffffff81b94776-0xffffffff81b944d0))'
// SEC("kprobe/xfrm_replay_advance+0x2a6")
// int BPF_KPROBE(prog4)
// {
//     u64 rbx = ctx->bx;
//     u64 addr_replay_esn_bmp = rbx + 0x18;
//     u64 start_addr = bpf_get_slab_start(addr_replay_esn_bmp);
//     u64 buf_len = bpf_get_buff_len(addr_replay_esn_bmp);
//     u64 end_addr = start_addr + (u32)buf_len;
//     u64 addr_replay_esn_bmp_nr = addr_replay_esn_bmp + (ctx->di) * 4;
//     int oob = addr_replay_esn_bmp_nr > end_addr;
    

//     bpf_printk("xfrm_replay_advance2: oob:%d\n", oob);
//     bpf_printk("xfrm_replay_advance: replay_esn->bmp[nr]:0x%lx, [0x%lx, 0x%lx)\n", addr_replay_esn_bmp_nr, start_addr, end_addr);

//     return 0;
// }



char LICENSE[] SEC("license") = "Dual BSD/GPL";


// struct nlattr {
//         __u16                      nla_len;              /*     0     2 */
//         __u16                      nla_type;             /*     2     2 */

//         /* size: 4, cachelines: 1, members: 2 */
//         /* last cacheline: 4 bytes */
// };

// struct xfrm_replay_state_esn {
//         unsigned int               bmp_len;              /*     0     4 */
//         __u32                      oseq;                 /*     4     4 */
//         __u32                      seq;                  /*     8     4 */
//         __u32                      oseq_hi;              /*    12     4 */
//         __u32                      seq_hi;               /*    16     4 */
//         __u32                      replay_window;        /*    20     4 */
//         __u32                      bmp[];                /*    24     0 */

//         /* size: 24, cachelines: 1, members: 7 */
//         /* last cacheline: 24 bytes */
// };

// 0x10ded822:   DW_TAG_subprogram
//                 DW_AT_name      ("xfrm_new_ae")
//                 DW_AT_decl_file ("/root/linux-5.15/net/xfrm/xfrm_user.c")
//                 DW_AT_decl_line (2291)
//                 DW_AT_decl_column       (0x0c)
//                 DW_AT_prototyped        (true)
//                 DW_AT_type      (0x10dc2c1d "int")
//                 DW_AT_ranges    (0x01213970
//                    [0xffffffff81b74320, 0xffffffff81b744db)
//                    [0xffffffff81d59820, 0xffffffff81d5983f))
//                 DW_AT_frame_base        (DW_OP_call_frame_cfa)
//                 DW_AT_GNU_all_call_sites        (true)
//                 DW_AT_sibling   (0x10dedd6b)

// 0x10dedb86:     DW_TAG_inlined_subroutine
//                   DW_AT_abstract_origin (0x10df62be "xfrm_replay_verify_len")
//                   DW_AT_entry_pc        (0xffffffff81b7440b)
//                   DW_AT_unknown_2138    (0x0000)
//                   DW_AT_ranges  (0x01213b20
//                      [0xffffffff81b7440b, 0xffffffff81b74415)
//                      [0xffffffff81b74415, 0xffffffff81b7443a)
//                      [0xffffffff81b7444e, 0xffffffff81b74457)
//                      [0xffffffff81d59820, 0xffffffff81d5983a)
//                      [0xffffffff81d5983a, 0xffffffff81d5983f))
//                   DW_AT_call_file       ("/root/linux-5.15/net/xfrm/xfrm_user.c")
//                   DW_AT_call_line       (2323)
//                   DW_AT_call_column     (0x08)
//                   DW_AT_sibling (0x10dedc7e)

// 0x10dedba1:       DW_TAG_formal_parameter
//                     DW_AT_abstract_origin       (0x10df62dd "rp")
//                     DW_AT_location      (0x0395ac01:
//                        [0xffffffff81b7440b, 0xffffffff81b74442): DW_OP_reg13 R13
//                        [0xffffffff81b7444e, 0xffffffff81b74462): DW_OP_reg13 R13
//                        [0xffffffff81b744db, 0xffffffff81b744db): DW_OP_reg13 R13
//                        [0xffffffff81d59820, 0xffffffff81d5983a): DW_OP_reg13 R13)
//                     DW_AT_unknown_2137  (0x0395abf9)

// 0x10dedbae:       DW_TAG_formal_parameter
//                     DW_AT_abstract_origin       (0x10df62d0 "replay_esn")
//                     DW_AT_location      (0x0395ac67:
//                        [0xffffffff81b7440b, 0xffffffff81b7442f): DW_OP_reg0 RAX
//                        [0xffffffff81b7442f, 0xffffffff81b74442): DW_OP_breg6 RBP+416
//                        [0xffffffff81b7444e, 0xffffffff81b74462): DW_OP_breg6 RBP+416
//                        [0xffffffff81b744db, 0xffffffff81b744db): DW_OP_breg6 RBP+416
//                        [0xffffffff81d59820, 0xffffffff81d59839): DW_OP_breg6 RBP+416)
//                     DW_AT_unknown_2137  (0x0395ac5d)

// 0x10dedbc0:         DW_TAG_variable
//                       DW_AT_abstract_origin     (0x10df62e9 "up")
//                       DW_AT_location    (0x0395ace6:
//                          [0xffffffff81b74415, 0xffffffff81b74442): DW_OP_breg13 R13+4, DW_OP_stack_value
//                          [0xffffffff81b7444e, 0xffffffff81b74462): DW_OP_breg13 R13+4, DW_OP_stack_value
//                          [0xffffffff81b744db, 0xffffffff81b744db): DW_OP_breg13 R13+4, DW_OP_stack_value
//                          [0xffffffff81d59820, 0xffffffff81d5983f): DW_OP_breg13 R13+4, DW_OP_stack_value)
//                       DW_AT_unknown_2137        (0x0395acde)



// 0x110e5a31:     DW_TAG_inlined_subroutine
//                   DW_AT_abstract_origin (0x110e52c6 "xfrm_replay_advance_esn")
//                   DW_AT_entry_pc        (0xffffffff81b945e7)
//                   DW_AT_unknown_2138    (0x0002)
//                   DW_AT_ranges  (0x012459f0
//                      [0xffffffff81b9452f, 0xffffffff81b94533)
//                      [0xffffffff81b94539, 0xffffffff81b94539)
//                      [0xffffffff81b94539, 0xffffffff81b94539)
//                      [0xffffffff81b94539, 0xffffffff81b94539)
//                      [0xffffffff81b94539, 0xffffffff81b94545)
//                      [0xffffffff81b945ad, 0xffffffff81b945b1)
//                      [0xffffffff81b945b1, 0xffffffff81b945b1)
//                      [0xffffffff81b945b1, 0xffffffff81b945b1)
//                      [0xffffffff81b945b1, 0xffffffff81b945bd)
//                      [0xffffffff81b945e7, 0xffffffff81b9465b)
//                      [0xffffffff81b946d4, 0xffffffff81b947b5)
//                      [0xffffffff81b947e9, 0xffffffff81b94826))
//                   DW_AT_call_file       ("/root/linux-5.15/net/xfrm/xfrm_replay.c")
//                   DW_AT_call_line       (166)
//                   DW_AT_call_column     (0x0a)
//                   DW_AT_sibling (0x110e5c61)

// 0x110e5acb:         DW_TAG_variable
//                       DW_AT_abstract_origin     (0x110e5351 "replay_esn")
//                       DW_AT_location    (0x039fa473:
//                          [0xffffffff81b945ee, 0xffffffff81b9465b): DW_OP_reg3 RBX
//                          [0xffffffff81b946ce, 0xffffffff81b947b5): DW_OP_reg3 RBX
//                          [0xffffffff81b947e9, 0xffffffff81b947f9): DW_OP_reg3 RBX
//                          [0xffffffff81b94801, 0xffffffff81b94826): DW_OP_reg3 RBX)
//                       DW_AT_unknown_2137        (0x039fa46b)

// 0x110e5a78:         DW_TAG_variable
//                       DW_AT_abstract_origin     (0x110e52f9 "nr")
//                       DW_AT_location    (0x039fa1ad:
//                          [0xffffffff81b94711, 0xffffffff81b9472a): DW_OP_breg1 RDX+0, DW_OP_lit5, DW_OP_shr, DW_OP_stack_value
//                          [0xffffffff81b94764, 0xffffffff81b94780): DW_OP_breg14 R14+0, DW_OP_lit5, DW_OP_shr, DW_OP_stack_value
//                          [0xffffffff81b9478d, 0xffffffff81b947b5): DW_OP_breg5 RDI-1, DW_OP_lit5, DW_OP_shr, DW_OP_stack_value)
//                       DW_AT_unknown_2137        (0x039fa1a7)

// pahole xfrm_replay_state_esn
// struct xfrm_replay_state_esn {
//         unsigned int               bmp_len;              /*     0     4 */
//         __u32                      oseq;                 /*     4     4 */
//         __u32                      seq;                  /*     8     4 */
//         __u32                      oseq_hi;              /*    12     4 */
//         __u32                      seq_hi;               /*    16     4 */
//         __u32                      replay_window;        /*    20     4 */
//         __u32                      bmp[];                /*    24     0 */

//         /* size: 24, cachelines: 1, members: 7 */
//         /* last cacheline: 24 bytes */
// };




// ffffffff81bf6fe0 <xfrm_replay_advance>:
// ...
// ffffffff81bf71ee:       41 21 44 bd 18          and    %eax,0x18(%r13,%rdi,4)


// 0xffffffff81bf71ee    278     25      1   0             0


// 0xffffffff81bf71c6    278     34      1   0             0
//     ffffffff81bf71c6:       41 b9 01 00 00 00       mov    $0x1,%r9d
// 0xffffffff81bf71e0    278     34      1   0             0
// 0xffffffff81bf71e5    278     34      1   0             0
// 0xffffffff81bf71ea    278      5      1   0             0  is_stmt
// 0xffffffff81bf71ec    278     29      1   0             0
// 0xffffffff81bf71ee    278     25      1   0             0