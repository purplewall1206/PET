#include "vmlinux.h"
#include <bpf/bpf_helpers.h>
#include <bpf/bpf_tracing.h>
#include <bpf/bpf_core_read.h>

u64 ret_apparmor_setprocattr = 0xffffffff814ed311;

struct {
    __uint(type, BPF_MAP_TYPE_HASH);
    __uint(max_entries, 200);
    __type(key, u32); // pid
    __type(value, struct pt_regs); 
} checkpoints SEC(".maps");


SEC("kprobe/apparmor_setprocattr")
int BPF_KPROBE(checkpoint_setup)
{
    u32 pid = bpf_get_current_pid_tgid();
    struct pt_regs x_regs = {};
        x_regs.r15 = ctx->r15 ;
        x_regs.r14 = ctx->r14 ;
        x_regs.r13 = ctx->r13 ;
        x_regs.r12 = ctx->r12 ;
        x_regs.bp  = ctx->bp  ;
        x_regs.bx  = ctx->bx  ;
        x_regs.r11 = ctx->r11;
        x_regs.r10 = ctx->r10;
        x_regs.r9  = ctx->r9 ;
        x_regs.r8  = ctx->r8 ;
        x_regs.ax  = ctx->ax ;
        x_regs.cx  = ctx->cx ;
        x_regs.dx  = ctx->dx ;
        x_regs.si  = ctx->si ;
        x_regs.di  = ctx->di ;
    x_regs.orig_ax = ctx->orig_ax;
        x_regs.ip = ctx->ip;
        x_regs.cs = ctx->cs;
        x_regs.flags = ctx->flags;
        x_regs.sp = ctx->sp;
        x_regs.ss = ctx->ss;
    int err = bpf_map_update_elem(&checkpoints, &pid, &x_regs, BPF_ANY);
    return 0;
}

SEC("kretprobe/apparmor_setprocattr")
int BPF_KRETPROBE(checkpoint_remove)
{
    u32 pid = bpf_get_current_pid_tgid();
    struct pt_regs* pregs = bpf_map_lookup_elem(&checkpoints, &pid);
    if (pregs) {
        int err = bpf_map_delete_elem(&checkpoints, &pid);
    }
    return 0;
}

int restore(struct pt_regs *ctx, u64 errcode, u64 retaddr)
{
    int err = bpf_send_signal(9);// SIGKILL
    u32 pid = bpf_get_current_pid_tgid();
    struct pt_regs *px_regs = bpf_map_lookup_elem(&checkpoints, &pid);
    if (px_regs) {
        px_regs->ax = errcode;
        px_regs->ip = retaddr;
        err = bpf_set_regs(ctx, px_regs);
    }
    return 0;
}

// where is value?

// static int apparmor_setprocattr(const char *name, void *value,
// 				size_t size)
// {
// 	// char *command, *largs = NULL, *args = value;
// 	char *command, *args = value;
// 	size_t arg_size;
// 	int error;
// ...
// 	/* AppArmor requires that the buffer must be null terminated atm */
// 	if (args[size - 1] != '\0') {
// ...
// 		if (size == PAGE_SIZE)
// 			return -EINVAL;
// 645		args[size] = '\0';  // off-by-one-byte ***********OOB************** 0xffffffff814c3aff,0xffffffff814d3b9b
// 	}

// ffffffff814c3a70 <apparmor_setprocattr>:
// ...
// ffffffff814c3af2:       48 81 fa 00 10 00 00    cmp    $0x1000,%rdx
// ffffffff814c3af9:       0f 84 f7 01 00 00       je     ffffffff814c3cf6 <apparmor_setprocattr+0x286>
// ffffffff814c3aff:       c6 04 16 00             movb   $0x0,(%rsi,%rdx,1)


// args: (DW_OP_fbreg -176) 0xb0
// size: [0xffffffff814c3a70, 0xffffffff814c3b0a): DW_OP_reg1 RDX 
//   DW_CFA_offset: RBX -40
//   DW_CFA_advance_loc: 7
//   DW_CFA_def_cfa_offset: +176
// python -c 'print(hex(0xffffffff814c3aff-0xffffffff814c3a70))'
// python -c 'print(hex(0xffffffff815482b1-0xffffffff81548220))'
// python -c 'print(hex(0xffffffff814ed190-0xffffffff814ed21f))'
// SEC("kprobe/apparmor_setprocattr+0x8f")
SEC("kprobe/apparmor_setprocattr+0x8f")
int BPF_KPROBE(prog1)
{
    u64 args = ctx->si;
    u64 size = ctx->dx;
    // bpf_printk("args: 0x%lx, size: 0x%lx\n", args, size);
    u64 objsize = bpf_get_buff_len(args);
    // bpf_printk("buff_len: 0x%lx\n", objsize);
    bool check = (size >= objsize);
    if (check) {
        bpf_printk("====CVE-2016-6187 out-of-bound happened====\n");
        restore(ctx, (u64)((u32)(-1)), ret_apparmor_setprocattr);
    }
    return 0;
}


// in v4.15, buffer 'page' is memdup_user, from kmalloc_track_caller
// but origin buffer is get_free_page.

// static ssize_t proc_pid_attr_write(struct file * file, const char __user * buf,
// 				   size_t count, loff_t *ppos)
// 	void *page;
// 	page = memdup_user(buf, count);    

// ffffffff81372060 <proc_pid_attr_write>:
// ...
// ffffffff813720fc:       4c 89 ff                mov    %r15,%rdi
// ffffffff813720ff:       4c 89 e6                mov    %r12,%rsi
// ffffffff81372102:       e8 29 d4 f0 ff          call   ffffffff8127f530 <memdup_user>
// ffffffff81372107:       49 89 c7                mov    %rax,%r15
// ffffffff8137210a:       89 c5                   mov    %eax,%ebp


// page: %rax
// count: %r12
// buf: %r15
// python -c 'print(hex(0xffffffff81372107-0xffffffff81372060))'
// SEC("kprobe/proc_pid_attr_write+0x43")
// int BPF_KRETPROBE(prog2)
// {

//     return 0;
// }


// // python -c 'print(hex(0xffffffff81d5789a-0xffffffff81d577ff))'
// SEC("kprobe/nft_set_elem_init.cold+0x9b")
// int BPF_KPROBE(prog3)
// {

//     return 0;
// }


char LICENSE[] SEC("license") = "Dual BSD/GPL";


// 0x05f5eeec:   DW_TAG_subprogram
//                 DW_AT_name      ("apparmor_setprocattr")
//                 DW_AT_decl_file ("/root/linux-5.15/security/apparmor/lsm.c")
//                 DW_AT_decl_line (624)
//                 DW_AT_decl_column       (0x0c)
//                 DW_AT_prototyped        (true)
//                 DW_AT_type      (0x05f2ba97 "int")
//                 DW_AT_low_pc    (0xffffffff814c3a70)
//                 DW_AT_high_pc   (0xffffffff814c3e5b)
//                 DW_AT_frame_base        (DW_OP_call_frame_cfa)
//                 DW_AT_GNU_all_call_sites        (true)
//                 DW_AT_sibling   (0x05f5fa2e)

// 0x05f5ef39:     DW_TAG_formal_parameter
//                   DW_AT_name    ("size")
//                   DW_AT_decl_file       ("/root/linux-5.15/security/apparmor/lsm.c")
//                   DW_AT_decl_line       (625)
//                   DW_AT_decl_column     (0x0c)
//                   DW_AT_type    (0x05f2bd41 "size_t")
//                   DW_AT_location        (0x01928963:
//                      [0xffffffff814c3a70, 0xffffffff814c3b0a): DW_OP_reg1 RDX
//                      [0xffffffff814c3b0a, 0xffffffff814c3bcd): DW_OP_reg3 RBX
//                      [0xffffffff814c3bcd, 0xffffffff814c3bf2): DW_OP_GNU_entry_value(DW_OP_reg1 RDX), DW_OP_stack_value
//                      [0xffffffff814c3bf2, 0xffffffff814c3cf1): DW_OP_reg3 RBX
//                      [0xffffffff814c3cf1, 0xffffffff814c3d00): DW_OP_GNU_entry_value(DW_OP_reg1 RDX), DW_OP_stack_value
//                      [0xffffffff814c3d00, 0xffffffff814c3d24): DW_OP_reg3 RBX
//                      [0xffffffff814c3d24, 0xffffffff814c3e5b): DW_OP_GNU_entry_value(DW_OP_reg1 RDX), DW_OP_stack_value)
//                   DW_AT_unknown_2137    (0x01928955)

// 0x05f5ef63:     DW_TAG_variable
//                   DW_AT_name    ("args")
//                   DW_AT_decl_file       ("/root/linux-5.15/security/apparmor/lsm.c")
//                   DW_AT_decl_line       (628)
//                   DW_AT_decl_column     (0x12)
//                   DW_AT_type    (0x05f2bc5b "char*")
//                   DW_AT_location        (DW_OP_fbreg -176)


// 0x042d1f73:   DW_TAG_subprogram
//                 DW_AT_name      ("proc_pid_attr_write")
//                 DW_AT_decl_file ("/root/linux-5.15/fs/proc/base.c")
//                 DW_AT_decl_line (2708)
//                 DW_AT_decl_column       (0x10)
//                 DW_AT_prototyped        (true)
//                 DW_AT_type      (0x042b4acd "ssize_t")
//                 DW_AT_low_pc    (0xffffffff81372060)
//                 DW_AT_high_pc   (0xffffffff813721af)
//                 DW_AT_frame_base        (DW_OP_call_frame_cfa)
//                 DW_AT_GNU_all_call_sites        (true)
//                 DW_AT_sibling   (0x042d2567)

// 0x042d1fab:     DW_TAG_formal_parameter
//                   DW_AT_name    ("buf")
//                   DW_AT_decl_file       ("/root/linux-5.15/fs/proc/base.c")
//                   DW_AT_decl_line       (2708)
//                   DW_AT_decl_column     (0x4c)
//                   DW_AT_type    (0x042b480e "const char*")
//                   DW_AT_location        (0x01288bf9:
//                      [0xffffffff81372060, 0xffffffff813720aa): DW_OP_reg4 RSI
//                      [0xffffffff813720aa, 0xffffffff8137210a): DW_OP_reg15 R15
//                      [0xffffffff8137210a, 0xffffffff81372173): DW_OP_GNU_entry_value(DW_OP_reg4 RSI), DW_OP_stack_value
//                      [0xffffffff81372173, 0xffffffff8137217c): DW_OP_reg4 RSI
//                      [0xffffffff8137217c, 0xffffffff813721af): DW_OP_reg15 R15)
//                   DW_AT_unknown_2137    (0x01288bef)

// 0x042d2014:     DW_TAG_variable
//                   DW_AT_name    ("page")
//                   DW_AT_decl_file       ("/root/linux-5.15/fs/proc/base.c")
//                   DW_AT_decl_line       (2713)
//                   DW_AT_decl_column     (0x08)
//                   DW_AT_type    (0x042b4c5b "*")
//                   DW_AT_location        (0x01288e17:
//                      [0xffffffff8137210a, 0xffffffff8137211b): DW_OP_reg0 RAX
//                      [0xffffffff8137211b, 0xffffffff81372164): DW_OP_reg15 R15)
//                   DW_AT_unknown_2137    (0x01288e13)

// 0x042d1fc0:     DW_TAG_formal_parameter
//                   DW_AT_name    ("count")
//                   DW_AT_decl_file       ("/root/linux-5.15/fs/proc/base.c")
//                   DW_AT_decl_line       (2709)
//                   DW_AT_decl_column     (0x0f)
//                   DW_AT_type    (0x042b4abc "size_t")
//                   DW_AT_location        (0x01288c71:
//                      [0xffffffff81372060, 0xffffffff8137207b): DW_OP_reg1 RDX
//                      [0xffffffff8137207b, 0xffffffff8137216c): DW_OP_reg12 R12
//                      [0xffffffff81372173, 0xffffffff813721af): DW_OP_reg12 R12)
//                   DW_AT_unknown_2137    (0x01288c6b)


// ffffffff814fa621:       c6 04 16 00             movb   $0x0,(%rsi,%rdx,1)

// 0xffffffff814fa621    645      3      1   0             0  is_stmt