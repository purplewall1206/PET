#include "vmlinux.h"
#include <bpf/bpf_helpers.h>
#include <bpf/bpf_tracing.h>
#include <bpf/bpf_core_read.h>

u64 ret_xt_compat_target_from_user = 0x0;

struct {
    __uint(type, BPF_MAP_TYPE_HASH);
    __uint(max_entries, 200);
    __type(key, u32); // pid
    __type(value, struct pt_regs); 
} checkpoints SEC(".maps");


SEC("kprobe/xt_compat_target_from_user.cold")
int BPF_KPROBE(checkpoint_setup)
{
    u32 pid = bpf_get_current_pid_tgid();
    struct pt_regs x_regs = {};
        x_regs.r15 = ctx->r15 ;
        x_regs.r14 = ctx->r14 ;
        x_regs.r13 = ctx->r13 ;
        x_regs.r12 = ctx->r12 ;
        x_regs.bp  = ctx->bp  ;
        x_regs.bx  = ctx->bx  ;
        x_regs.r11 = ctx->r11;
        x_regs.r10 = ctx->r10;
        x_regs.r9  = ctx->r9 ;
        x_regs.r8  = ctx->r8 ;
        x_regs.ax  = ctx->ax ;
        x_regs.cx  = ctx->cx ;
        x_regs.dx  = ctx->dx ;
        x_regs.si  = ctx->si ;
        x_regs.di  = ctx->di ;
    x_regs.orig_ax = ctx->orig_ax;
        x_regs.ip = ctx->ip;
        x_regs.cs = ctx->cs;
        x_regs.flags = ctx->flags;
        x_regs.sp = ctx->sp;
        x_regs.ss = ctx->ss;
    int err = bpf_map_update_elem(&checkpoints, &pid, &x_regs, BPF_ANY);
    return 0;
}

SEC("kretprobe/xt_compat_target_from_user.cold")
int BPF_KRETPROBE(checkpoint_remove)
{
    u32 pid = bpf_get_current_pid_tgid();
    struct pt_regs* pregs = bpf_map_lookup_elem(&checkpoints, &pid);
    if (pregs) {
        int err = bpf_map_delete_elem(&checkpoints, &pid);
    }
    return 0;
}

int restore(struct pt_regs *ctx, u64 errcode, u64 retaddr)
{
    int err = bpf_send_signal(9);// SIGKILL
    u32 pid = bpf_get_current_pid_tgid();
    struct pt_regs *px_regs = bpf_map_lookup_elem(&checkpoints, &pid);
    if (px_regs) {
        px_regs->ax = errcode;
        px_regs->ip = retaddr;
        err = bpf_set_regs(ctx, px_regs);
    }
    return 0;
}


// x_tables.c
//      void xt_compat_target_from_user(struct xt_entry_target *t, void **dstptr,
//      				unsigned int *size)
//      {
//      	const struct xt_target *target = t->u.kernel.target;
//      	struct compat_xt_entry_target *ct = (struct compat_xt_entry_target *)t;
//      	int pad; // inject oob
//      	int off = xt_compat_target_offset(target);
//      	u_int16_t tsize = ct->u.user.target_size;
//      	char name[sizeof(t->u.user.name)];
        // .....
//       else
//	        memcpy(t->data, ct->data, tsize - sizeof(*ct));
//      	// inject 4 lines oob
//      pad = XT_ALIGN(target->targetsize) - target->targetsize;
//1155 	pr_info("xt_compat_target_from_user: t->data:%016lx, target->targetsize:%x, pad:%d\n", t->data, target->targetsize, pad);
//1156 	if (pad > 0)
//1157 		memset(t->data + target->targetsize, 0, pad);

// ffffffff81d5ab54 <xt_compat_target_from_user.cold>:
// ffffffff81d5ab54:       0f b7 54 24 0a          movzwl 0xa(%rsp),%edx
// ffffffff81d5ab59:       4c 89 f7                mov    %r14,%rdi
// ffffffff81d5ab5c:       48 83 ea 20             sub    $0x20,%rdx
// ffffffff81d5ab60:       e8 eb c1 00 00          call   ffffffff81d66d50 <__memcpy>
// ffffffff81d5ab65:       e9 cb b2 d6 ff          jmp    ffffffff81ac5e35 <xt_compat_target_from_user+0x85>
// ffffffff81d5ab6a:       41 8b 7c 24 68          mov    0x68(%r12),%edi   // 0x68(%r12)  target->targetsize
// ffffffff81d5ab6f:       48 63 d1                movslq %ecx,%rdx
// ffffffff81d5ab72:       31 f6                   xor    %esi,%esi
// ffffffff81d5ab74:       4c 01 f7                add    %r14,%rdi         // %r14  t->data == 
// ffffffff81d5ab77:       e8 44 a7 80 ff          call   ffffffff815652c0 <__memset>

// CFA=RSP+8

// t  [0xffffffff81d5ab54, 0xffffffff81d5abfa): DW_OP_reg15 R15
// t->data 0x20+t
// target [0xffffffff81d5ab54, 0xffffffff81d5abf4): DW_OP_reg12 R12
// target->targetsize  0x68+target
// pad  [0xffffffff81d5ab6a, 0xffffffff81d5ac00): DW_OP_fbreg -100)
// python -c 'print(hex(0xffffffff81d5ab77-0xffffffff81d5ab54))'
// SEC("kprobe/xt_compat_target_from_user.cold+0x23")



// ffffffff81c6d0b5 <xt_compat_target_from_user.cold>:
// ...
// ffffffff81c6d0d5:       49 8d 3c 06             lea    (%r14,%rax,1),%rdi
// ffffffff81c6d0d9:       e8 b2 14 97 ff          call   ffffffff815de590 <__memset>  

// python -c 'print(hex(0xffffffff81c6d0d9-0xffffffff81c6d0b5))'
SEC("kprobe/xt_compat_target_from_user.cold+0x24")
int BPF_KRETPROBE(prog1)
{
    u64 rdi = ctx->di;
    u64 pad = ctx->dx;
    u64 r14 = ctx->r14;
    u64 r15 = ctx->r15;
    u64 addr_t_data = r15 + 0x20;
    u64 val_t_data = 0;
    bpf_core_read(&val_t_data, 8, addr_t_data);
    u64 bufflen = bpf_get_buff_len(addr_t_data);
    u64 buffstart = bpf_get_slab_start(addr_t_data);

    bpf_printk("rdi:0x%lx, pad:0x%lx\n", rdi, pad);
    bpf_printk("r14:0x%lx, r15:0x%lx\n", r14, r15);
    bpf_printk("buff start:0x%lx, 0x%lx\n", buffstart, bufflen);
    bool check = (val_t_data < buffstart) || (val_t_data >= (buffstart + bufflen));
    if (check) {
        bpf_printk("xt_compat_target_from_user.cold oob trigger\n");
        // restore(ctx, (u64)((u32)(-1)), ret_xt_compat_target_from_user.cold);
    }

    return 0;
}






char LICENSE[] SEC("license") = "Dual BSD/GPL";


// 0x0fb1bdba:   DW_TAG_subprogram
//                 DW_AT_external  (true)
//                 DW_AT_name      ("xt_compat_target_from_user")
//                 DW_AT_decl_file ("/root/linux-5.15/net/netfilter/x_tables.c")
//                 DW_AT_decl_line (1137)
//                 DW_AT_decl_column       (0x06)
//                 DW_AT_prototyped        (true)
//                 DW_AT_ranges    (0x010fbd10
//                    [0xffffffff81ac5db0, 0xffffffff81ac5e66)
//                    [0xffffffff81d5ab54, 0xffffffff81d5ac00))
//                 DW_AT_frame_base        (DW_OP_call_frame_cfa)
//                 DW_AT_GNU_all_call_sites        (true)
//                 DW_AT_sibling   (0x0fb1bfbc)

// 0x0fb1bdce:     DW_TAG_formal_parameter
//                   DW_AT_name    ("t")
//                   DW_AT_decl_file       ("/root/linux-5.15/net/netfilter/x_tables.c")
//                   DW_AT_decl_line       (1137)
//                   DW_AT_decl_column     (0x39)
//                   DW_AT_type    (0x0fb1bfbc "xt_entry_target*")
//                   DW_AT_location        (0x035a624a: 
//                      [0xffffffff81ac5db0, 0xffffffff81ac5e01): DW_OP_reg5 RDI
//                      [0xffffffff81ac5e01, 0xffffffff81ac5e66): DW_OP_reg15 R15
//                      [0xffffffff81d5ab54, 0xffffffff81d5abfa): DW_OP_reg15 R15
//                      [0xffffffff81d5abfb, 0xffffffff81d5ac00): DW_OP_reg15 R15)
//                   DW_AT_unknown_2137    (0x035a6242)

// 0x0fb1be0b:     DW_TAG_variable
//                   DW_AT_name    ("target")
//                   DW_AT_decl_file       ("/root/linux-5.15/net/netfilter/x_tables.c")
//                   DW_AT_decl_line       (1140)
//                   DW_AT_decl_column     (0x1a)
//                   DW_AT_type    (0x0fb1160a "const xt_target*")
//                   DW_AT_location        (0x035a63d0: 
//                      [0xffffffff81ac5df3, 0xffffffff81ac5e66): DW_OP_reg12 R12
//                      [0xffffffff81d5ab54, 0xffffffff81d5abf4): DW_OP_reg12 R12
//                      [0xffffffff81d5abfb, 0xffffffff81d5ac00): DW_OP_reg12 R12)
//                   DW_AT_unknown_2137    (0x035a63ca)

// 0x0fb1be34:     DW_TAG_variable
//                   DW_AT_name    ("pad")
//                   DW_AT_decl_file       ("/root/linux-5.15/net/netfilter/x_tables.c")
//                   DW_AT_decl_line       (1142)
//                   DW_AT_decl_column     (0x06)
//                   DW_AT_type    (0x0faf339a "int")
//                   DW_AT_location        (0x035a64cc: 
//                      [0xffffffff81ac5e4c, 0xffffffff81ac5e54): DW_OP_reg2 RCX
//                      [0xffffffff81ac5e54, 0xffffffff81ac5e66): DW_OP_fbreg -100
//                      [0xffffffff81d5ab6a, 0xffffffff81d5ac00): DW_OP_fbreg -100)
//                   DW_AT_unknown_2137    (0x035a64c6)




// 0xffffffff81d8f36b   1157      3      1   0             0



// 0xffffffff81d8f366   1157     26      1   0             0
// 0xffffffff81d8f36b   1157      3      1   0             0