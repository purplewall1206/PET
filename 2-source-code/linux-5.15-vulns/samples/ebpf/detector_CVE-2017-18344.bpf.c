#include "vmlinux.h"
#include <bpf/bpf_helpers.h>
#include <bpf/bpf_tracing.h>
#include <bpf/bpf_core_read.h>


// fs/proc/base.c
// static int show_timer(struct seq_file *m, void *v)
//     ...
// 2457	int notify;
// 2458	static const char * const nstr[] = {
//             [SIGEV_SIGNAL] = "signal",
//             [SIGEV_NONE] = "none",
//             [SIGEV_THREAD] = "thread",
//         };
//     ....
// 2471	seq_printf(m, "notify: %s/%s.%d\n",      // rdi, rsi
// 2472		   nstr[notify & ~SIGEV_THREAD_ID],  // rdx
// 2473		   (notify & SIGEV_THREAD_ID) ? "tid" : "pid",  // rcx
// 2474		   pid_nr_ns(timer->it_pid, tp->ns));  // r8


// ffffffff81372b40 <show_timer>:
// ...
// ffffffff81372b82:       49 8b 75 18             mov    0x18(%r13),%rsi
// ffffffff81372b86:       48 8b 7b 68             mov    0x68(%rbx),%rdi
// ffffffff81372b8a:       e8 d1 58 d9 ff          call   ffffffff81108460 <pid_nr_ns>
// ffffffff81372b8f:       41 f6 c4 04             test   $0x4,%r12b
// ffffffff81372b93:       48 89 ef                mov    %rbp,%rdi
// ffffffff81372b96:       48 c7 c1 a4 8a 46 82    mov    $0xffffffff82468aa4,%rcx
// ffffffff81372b9d:       41 89 c0                mov    %eax,%r8d
// ffffffff81372ba0:       48 c7 c0 48 b7 4a 82    mov    $0xffffffff824ab748,%rax
// ffffffff81372ba7:       48 c7 c6 8c b8 4a 82    mov    $0xffffffff824ab88c,%rsi
// ffffffff81372bae:       48 0f 44 c8             cmove  %rax,%rcx
// ffffffff81372bb2:       41 83 e4 fb             and    $0xfffffffb,%r12d
// ffffffff81372bb6:       4d 63 e4                movslq %r12d,%r12
// ffffffff81372bb9:       4a 8b 14 e5 40 9c 23 82         mov    -0x7ddc63c0(,%r12,8),%rdx
// ffffffff81372bc1:       e8 1a 9d f9 ff          call   ffffffff8130c8e0 <seq_printf>


// nstr: 0xffffffff82239c40;
// nstr: len = 3*8
// notify: R12
// SIGEV_THREAD_ID: 4
// python -c 'print(hex(0xffffffff81372bc1-0xffffffff81372b40))'
SEC("kprobe/show_timer+0x81")
int BPF_KPROBE(prog1)
{
    u64 nstr = 0xffffffff82239c40;
    u64 r12 = ctx->r12; // notify & ~SIGEV_THREAD_ID
    u64 nstr_offset = nstr + (u32)r12 * sizeof(char*);
    u64 nstr_end = nstr + 3 * sizeof(char *);

    int oob = (nstr_offset < nstr) || (nstr_offset > nstr_end);

    bpf_printk("show_timer: nstr[notify & ~SIGEV_THREAD_ID]: 0x%lx\n", nstr_offset);
    bpf_printk("show_timer: oob:%d  [0x%lx, 0x%lx)\n", oob, nstr, nstr_end);
    return 0;
}







char LICENSE[] SEC("license") = "Dual BSD/GPL";

// 0x042df742:     DW_TAG_variable
//                   DW_AT_name    ("nstr")
//                   DW_AT_decl_file       ("/root/linux-5.15/fs/proc/base.c")
//                   DW_AT_decl_line       (2458)
//                   DW_AT_decl_column     (0x1c)
//                   DW_AT_type    (0x042c3f51 "const const const char*[3]")
//                   DW_AT_location        (DW_OP_addr 0xffffffff82239c40)

// 0x042df72d:     DW_TAG_variable
//                   DW_AT_name    ("notify")
//                   DW_AT_decl_file       ("/root/linux-5.15/fs/proc/base.c")
//                   DW_AT_decl_line       (2457)
//                   DW_AT_decl_column     (0x06)
//                   DW_AT_type    (0x042bf8ce "int")
//                   DW_AT_location        (0x0129142a: 
//                      [0xffffffff81372b63, 0xffffffff81372bb6): DW_OP_reg12 R12)
//                   DW_AT_unknown_2137    (0x01291428)