#include "vmlinux.h"
#include <bpf/bpf_helpers.h>
#include <bpf/bpf_tracing.h>
#include <bpf/bpf_core_read.h>

// nft_parse_register(const struct nlattr *attr)
/*
 *  <------- NLA_HDRLEN ------> <-- NLA_ALIGN(payload)-->
 * +---------------------+- - -+- - - - - - - - - -+- - -+
 * |        Header       | Pad |     Payload       | Pad |
 * |   (struct nlattr)   | ing |                   | ing |
 * +---------------------+- - -+- - - - - - - - - -+- - -+
 *  <-------------- nlattr->nla_len -------------->
 */

// inlined  nf_tables_api.c
// static int nft_validate_register_load(enum nft_registers reg, unsigned int len)
// {
    // ...
//     /* If there would be an OOB access whenever
//      * `reg` is taken as index and `len` bytes are read,
//      * bail out. 
//      * sizeof_field(struct nft_regs, data) == 0x50 */
// 9253    if (reg * NFT_REG32_SIZE + len > sizeof_field(struct nft_regs, data)) 
//         return -ERANGE;
//     return 0;
// }  

// ffffffff81d57774 <nft_parse_register_load>:
// ffffffff81d57774:       e8 17 1c 37 ff          call   ffffffff810c9390 <__fentry__>
// ffffffff81d57779:       55                      push   %rbp
// ffffffff81d5777a:       48 89 f5                mov    %rsi,%rbp
// ffffffff81d5777d:       53                      push   %rbx
// ffffffff81d5777e:       89 d3                   mov    %edx,%ebx
// ffffffff81d57780:       e8 a3 ff ff ff          call   ffffffff81d57728 <nft_parse_register>
// ffffffff81d57785:       83 f8 03                cmp    $0x3,%eax
// ffffffff81d57788:       76 1a                   jbe    ffffffff81d577a4 <nft_parse_register_load+0x30>
// ffffffff81d5778a:       85 db                   test   %ebx,%ebx
// ffffffff81d5778c:       74 16                   je     ffffffff81d577a4 <nft_parse_register_load+0x30>
// ffffffff81d5778e:       8d 14 83                lea    (%rbx,%rax,4),%edx  [line 9235]
// ffffffff81d57791:       41 b8 de ff ff ff       mov    $0xffffffde,%r8d
// ffffffff81d57797:       83 fa 50                cmp    $0x50,%edx  [check edx here]
// ffffffff81d5779a:       77 0e                   ja     ffffffff81d577aa <nft_parse_register_load+0x36>
// ffffffff81d5779c:       88 45 00                mov    %al,0x0(%rbp)
// ffffffff81d5779f:       45 31 c0                xor    %r8d,%r8d
// ffffffff81d577a2:       eb 06                   jmp    ffffffff81d577aa <nft_parse_register_load+0x36>
// ffffffff81d577a4:       41 b8 ea ff ff ff       mov    $0xffffffea,%r8d
// ffffffff81d577aa:       44 89 c0                mov    %r8d,%eax
// ffffffff81d577ad:       5b                      pop    %rbx
// ffffffff81d577ae:       5d                      pop    %rbp
// ffffffff81d577af:       c3                      ret

// len rbx
// reg rax
// python -c 'print(hex(0xffffffff81d5778e-0xffffffff81d57774))'
// SEC("kprobe/nft_parse_register_load+0x1a")
// int BPF_KRETPROBE(prog0)
// {
//     u64 len = ctx->bx;
//     u64 reg = ctx->ax;
//     bpf_printk("nft_parse_register_load: rax:0x%lx, len:0x%lx\n", reg, len);
//     return 0;
// }

// (reg * NFT_REG32_SIZE(4) + len > sizeof_field(struct nft_regs, data)) 
//       edx                        0x50
// python -c 'print(hex(0xffffffff81d57797-0xffffffff81d57774))'
// hex(0xffffffff81dbb9ec-0xffffffff81dbb9c9)
SEC("kprobe/nft_parse_register_load+0x23")
int BPF_KRETPROBE(prog1)
{
    int oob = ctx->dx < 0x50;
    u64 len = ctx->bx;
    u64 reg = ctx->ax;
    u32 simulate = (u32)(reg * 4 + len);
    bpf_printk("nft_parse_register_load: reg:0x%lx, len:0x%lx\n", reg, len);
    bpf_printk("nft_parse_register_load: sim 0x%x\n", simulate);

    bpf_printk("nft_parse_register_load: integer oob:%d\n", oob);
    return 0;
}



SEC("kretprobe/nft_parse_register_load")
int BPF_KRETPROBE(prog2)
{
    u64 ret = ctx->ax;
    bpf_printk("nft_parse_register_load ret:0x%lx\n", ret);
    return 0;
}


// 0x0f3fa854:   DW_TAG_subprogram
//                 DW_AT_external  (true)
//                 DW_AT_name      ("nft_parse_register_load")
//                 DW_AT_decl_file ("/root/linux-5.15/net/netfilter/nf_tables_api.c")
//                 DW_AT_decl_line (9259)
//                 DW_AT_decl_column       (0x05)
//                 DW_AT_prototyped        (true)
//                 DW_AT_type      (0x0f3d1a69 "int")
//                 DW_AT_low_pc    (0xffffffff81d57774)
//                 DW_AT_high_pc   (0xffffffff81d577b0)
//                 DW_AT_frame_base        (DW_OP_call_frame_cfa)
//                 DW_AT_GNU_all_call_sites        (true)
//                 DW_AT_sibling   (0x0f3fa92c)



// 0x0f3fa8e0:     DW_TAG_inlined_subroutine
//                   DW_AT_abstract_origin (0x0f3fa92c "nft_validate_register_load")
//                   DW_AT_entry_pc        (0xffffffff81d57785)
//                   DW_AT_unknown_2138    (0x0001)
//                   DW_AT_ranges  (0x010c1b90
//                      [0xffffffff81d57785, 0xffffffff81d5779c)
//                      [0xffffffff81d577a4, 0xffffffff81d577aa))
//                   DW_AT_call_file       ("/root/linux-5.15/net/netfilter/nf_tables_api.c")
//                   DW_AT_call_line       (9266)
//                   DW_AT_call_column     (0x08)
//                   DW_AT_sibling (0x0f3fa916)

// 0x0f3fa8fb:       DW_TAG_formal_parameter
//                     DW_AT_abstract_origin       (0x0f3fa94b "len")
//                     DW_AT_location      (0x034c06e8: 
//                        [0xffffffff81d57785, 0xffffffff81d5779c): DW_OP_reg3 RBX
//                        [0xffffffff81d577a4, 0xffffffff81d577aa): DW_OP_reg3 RBX)
//                     DW_AT_unknown_2137  (0x034c06e4)

// 0x0f3fa908:       DW_TAG_formal_parameter
//                     DW_AT_abstract_origin       (0x0f3fa93e "reg")
//                     DW_AT_location      (0x034c0722: 
//                        [0xffffffff81d57785, 0xffffffff81d5779c): DW_OP_reg0 RAX
//                        [0xffffffff81d577a4, 0xffffffff81d577aa): DW_OP_reg0 RAX)
//                     DW_AT_unknown_2137  (0x034c071e)


// nf_tables_core.c
//  nft_payload_fast_eval(inlined in nft_do_chain) -> dest is the arbitrary write primitive
// static bool nft_payload_fast_eval(const struct nft_expr *expr,
// 				  struct nft_regs *regs,
// 				  const struct nft_pktinfo *pkt)
    // const struct nft_payload *priv = nft_expr_priv(expr);
	// const struct sk_buff *skb = pkt->skb;
	// u32 *dest = &regs->data[priv->dreg];  // 76  ffffffff81a948ec, ffffffff81a94940
// ffffffff81a94933:       41 0f b6 75 0b          movzbl 0xb(%r13),%esi   [priv->dreg  (priv 0x8(%r13) + 0x3)]
// ffffffff81a94938:       c7 44 b4 50 00 00 00 00         movl   $0x0,0x50(%rsp,%rsi,4)   [u32 data[20]], regs:0x50(%rsp)
// ffffffff81a94940:       48 8d 7c b4 50          lea    0x50(%rsp,%rsi,4),%rdi  [u32 data[20]], regs:0x50(%rsp), $rsi: priv->dreg


// ********write content of ptr in dest****************
	// if (priv->len == 2)   // 93
	// 	*(u16 *)dest = *(u16 *)ptr;  //94  ffffffff81a949f0  -- f6
// ffffffff81a949f0:       0f b7 11                movzwl (%rcx),%edx
// ffffffff81a949f3:       66 89 17                mov    %dx,(%rdi)
// ffffffff81a949f6:       e9 5b fe ff ff          jmp    ffffffff81a94856 <nft_do_chain+0x166>
	// else if (priv->len == 4)
	// 	*(u32 *)dest = *(u32 *)ptr;  // 96  ffffffff81a94a23 -- 2e
// ffffffff81a94a23:       8b 09                   mov    (%rcx),%ecx
// ffffffff81a94a25:       89 4c 94 50             mov    %ecx,0x50(%rsp,%rdx,4)
// ffffffff81a94a29:       e9 28 fe ff ff          jmp    ffffffff81a94856 <nft_do_chain+0x166>
	// else
	// 	*(u8 *)dest = *(u8 *)ptr;  // 98   ffffffff81a94961 --- 66
// ffffffff81a94961:       0f b6 11                movzbl (%rcx),%edx
// ffffffff81a94964:       88 17                   mov    %dl,(%rdi)
// ffffffff81a94966:       e9 eb fe ff ff          jmp    ffffffff81a94856 <nft_do_chain+0x166>


// ffffffff81a94856:       44 8b 44 24 50          mov    0x50(%rsp),%r8d
// priv: R13+8
// regs: RSP+80
// dest: [0xffffffff81a948ec, 0xffffffff81a94940): DW_OP_breg13 R13+11, DW_OP_deref_size 0x1, DW_OP_const1u 0xff, DW_OP_and, DW_OP_lit2, DW_OP_shl, DW_OP_breg7 RSP+0, DW_OP_plus, DW_OP_plus_uconst 0x50, DW_OP_stack_value:   
//  so maybe  0x50(%rsp)
// ptr: rcx

// check here &regs->data[priv->dreg]; data len is 20 on stack
// priv->dreg < 20
// ffffffff81a94940:       48 8d 7c b4 50          lea    0x50(%rsp,%rsi,4),%rdi  [u32 data[20]], regs:0x50(%rsp), $rsi: priv->dreg
// python -c 'print(hex(0xffffffff81a94940 - 0xffffffff81a946f0))'
//  hex(0xffffffff81aaffc3-0xffffffff81aafd80)
SEC("kprobe/nft_do_chain+0x243")
int BPF_KPROBE(prog4)
{
    u64 regs_addr = ctx->sp + 0x50;
    u64 priv_dreg = ctx->si;
    u64 regs_data_priv_dreg = regs_addr + priv_dreg * 4;
    u64 regs_max = regs_addr + 4 * 20;
    int oob = (regs_data_priv_dreg < regs_addr) || (regs_data_priv_dreg > regs_max);
    bpf_printk("nft_do_chain: regs->data:%lx,  priv_dreg:%lx\n", regs_addr, priv_dreg);
    bpf_printk("nft_do_chain regs_max:%lx, regs->data[priv->dreg]:%lx\n", regs_max, regs_data_priv_dreg);
    bpf_printk("nft_do_chain: oob:%d  [0x%lx, 0x%lx)\n", oob, regs_addr, regs_max);
    return 0;
}

//  DW_AT_name      ("nft_do_chain")
//                 DW_AT_decl_file ("/root/linux-5.15/net/netfilter/nf_tables_core.c")
//                 DW_AT_decl_line (158)
//                 DW_AT_decl_column       (0x01)
//                 DW_AT_prototyped        (true)
//                 DW_AT_type      (0x0f3b1fe4 "unsigned int")
//                 DW_AT_low_pc    (0xffffffff81a946f0)
//                 DW_AT_high_pc   (0xffffffff81a94c24)

// 0x0f3d0b1d:     DW_TAG_inlined_subroutine
//                   DW_AT_abstract_origin (0x0f3d119e "nft_payload_fast_eval")
//                   DW_AT_entry_pc        (0xffffffff81a948e4)
//                   DW_AT_unknown_2138    (0x0001)
//                   DW_AT_ranges  (0x010beef0
//                      [0xffffffff81a948e4, 0xffffffff81a948e4)
//                      [0xffffffff81a948e4, 0xffffffff81a9490b)
//                      [0xffffffff81a9490b, 0xffffffff81a9497e)
//                      [0xffffffff81a949f0, 0xffffffff81a949fb)
//                      [0xffffffff81a94a23, 0xffffffff81a94a2e))
//                   DW_AT_call_file       ("/root/linux-5.15/net/netfilter/nf_tables_core.c")
//                   DW_AT_call_line       (191)
//                   DW_AT_call_column     (0x07)
//                   DW_AT_sibling (0x0f3d0c31)


// 0x0f3d0b44:       DW_TAG_formal_parameter
//                     DW_AT_abstract_origin       (0x0f3d11bc "regs")
//                     DW_AT_location      (0x034bc0ef:
//                        [0xffffffff81a948e4, 0xffffffff81a94966): DW_OP_breg7 RSP+80, DW_OP_stack_value
//                        [0xffffffff81a9496b, 0xffffffff81a9497e): DW_OP_breg7 RSP+80, DW_OP_stack_value
//                        [0xffffffff81a949f0, 0xffffffff81a949f6): DW_OP_breg7 RSP+80, DW_OP_stack_value
//                        [0xffffffff81a94a23, 0xffffffff81a94a29): DW_OP_breg7 RSP+80, DW_OP_stack_value)
//                     DW_AT_unknown_2137  (0x034bc0e7)

// 0x0f3d0b64:         DW_TAG_variable
//                       DW_AT_abstract_origin     (0x0f3d11d4 "priv")
//                       DW_AT_location    (0x034bc1c1:
//                          [0xffffffff81a948e4, 0xffffffff81a9497e): DW_OP_breg13 R13+8, DW_OP_stack_value
//                          [0xffffffff81a949f0, 0xffffffff81a949fb): DW_OP_breg13 R13+8, DW_OP_stack_value
//                          [0xffffffff81a94a23, 0xffffffff81a94a2e): DW_OP_breg13 R13+8, DW_OP_stack_value)
//                       DW_AT_unknown_2137        (0x034bc1bb)

// 0x0f3d0b7e:         DW_TAG_variable
//                       DW_AT_abstract_origin     (0x0f3d11ec "dest")
//                       DW_AT_location    (0x034bc290:
//                          [0xffffffff81a948ec, 0xffffffff81a94940): DW_OP_breg13 R13+11, DW_OP_deref_size 0x1, DW_OP_const1u 0xff, DW_OP_and, DW_OP_lit2, DW_OP_shl, DW_OP_breg7 RSP+0, DW_OP_plus, DW_OP_plus_uconst 0x50, DW_OP_stack_value
//                          [0xffffffff81a9496b, 0xffffffff81a9497e): DW_OP_breg13 R13+11, DW_OP_deref_size 0x1, DW_OP_const1u 0xff, DW_OP_and, DW_OP_lit2, DW_OP_shl, DW_OP_breg7 RSP+0, DW_OP_plus, DW_OP_plus_uconst 0x50, DW_OP_stack_value)
//                       DW_AT_unknown_2137        (0x034bc28c)

// 0x0f3d0b8b:         DW_TAG_variable
//                       DW_AT_abstract_origin     (0x0f3d11f8 "ptr")
//                       DW_AT_location    (0x034bc2ea:
//                          [0xffffffff81a94911, 0xffffffff81a94966): DW_OP_reg2 RCX
//                          [0xffffffff81a9497c, 0xffffffff81a9497e): DW_OP_reg2 RCX
//                          [0xffffffff81a949f0, 0xffffffff81a949f6): DW_OP_reg2 RCX
//                          [0xffffffff81a94a23, 0xffffffff81a94a25): DW_OP_reg2 RCX)
//                       DW_AT_unknown_2137        (0x034bc2e2)

// 0x0f3cede2:   DW_TAG_structure_type
//                 DW_AT_name      ("nft_regs")
//                 DW_AT_byte_size (0x50)
//                 DW_AT_decl_file ("/root/linux-5.15/./include/net/netfilter/nf_tables.h")
//                 DW_AT_decl_line (126)
//                 DW_AT_decl_column       (0x08)
//                 DW_AT_sibling   (0x0f3cedf6)

// 0x0f3cedef:     DW_TAG_member
//                   DW_AT_type    (0x0f3cedc0 "union ")
//                   DW_AT_data_member_location    (0x00)

// struct nft_regs {
// 	union {
// 		u32			data[20];
// 		struct nft_verdict	verdict;
// 	};
// };

// 0x0f3d01bb:   DW_TAG_structure_type
//                 DW_AT_name      ("nft_payload")
//                 DW_AT_byte_size (0x04)
//                 DW_AT_decl_file ("/root/linux-5.15/./include/net/netfilter/nf_tables_core.h")
//                 DW_AT_decl_line (61)
//                 DW_AT_decl_column       (0x08)
//                 DW_AT_sibling   (0x0f3d0205)

// 0x0f3d01c9:     DW_TAG_member
//                   DW_AT_name    ("base")
//                   DW_AT_decl_file       ("/root/linux-5.15/./include/net/netfilter/nf_tables_core.h")
//                   DW_AT_decl_line       (62)
//                   DW_AT_decl_column     (0x19)
//                   DW_AT_type    (0x0f3ce1af "nft_payload_bases")
//                   DW_AT_byte_size       (0x04)
//                   DW_AT_bit_size        (0x08)
//                   DW_AT_bit_offset      (0x18)
//                   DW_AT_data_member_location    (0x00)

// 0x0f3d01da:     DW_TAG_member
//                   DW_AT_name    ("offset")
//                   DW_AT_decl_file       ("/root/linux-5.15/./include/net/netfilter/nf_tables_core.h")
//                   DW_AT_decl_line       (63)
//                   DW_AT_decl_column     (0x07)
//                   DW_AT_type    (0x0f3b209a "u8")
//                   DW_AT_data_member_location    (0x01)

// 0x0f3d01e8:     DW_TAG_member
//                   DW_AT_name    ("len")
//                   DW_AT_decl_file       ("/root/linux-5.15/./include/net/netfilter/nf_tables_core.h")
//                   DW_AT_decl_line       (64)
//                   DW_AT_decl_column     (0x07)
//                   DW_AT_type    (0x0f3b209a "u8")
//                   DW_AT_data_member_location    (0x02)

// 0x0f3d01f6:     DW_TAG_member
//                   DW_AT_name    ("dreg")
//                   DW_AT_decl_file       ("/root/linux-5.15/./include/net/netfilter/nf_tables_core.h")
//                   DW_AT_decl_line       (65)
//                   DW_AT_decl_column     (0x07)
//                   DW_AT_type    (0x0f3b209a "u8")
//                   DW_AT_data_member_location    (0x03)

// struct nft_payload {
// 	enum nft_payload_bases	base:8;
// 	u8			offset;
// 	u8			len;
// 	u8			dreg;
// };

char LICENSE[] SEC("license") = "Dual BSD/GPL";

