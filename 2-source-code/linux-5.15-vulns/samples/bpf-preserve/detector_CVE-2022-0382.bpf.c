#include "vmlinux.h"
#include <bpf/bpf_helpers.h>
#include <bpf/bpf_tracing.h>
#include <bpf/bpf_core_read.h>


// static int __tipc_sendmsg(struct socket *sock, struct msghdr *m, size_t dlen)
// {
// 	struct tipc_socket_addr skaddr;


// struct tipc_socket_addr {
//         __u32                      ref;                  /*     0     4 */
//         __u32                      node;                 /*     4     4 */

//         /* size: 8, cachelines: 1, members: 2 */
//         /* last cacheline: 8 bytes */
// };

//                 DW_AT_name      ("skaddr")
//                 DW_AT_decl_file ("/home/ppw/Documents/ebpf-detector/linux-5.15-vulns/net/tipc/socket.c")
//                 DW_AT_decl_line (1419)
//                 DW_AT_decl_column       (0x1a)
//                 DW_AT_type      (0x0df32f64 "tipc_socket_addr")
//                 DW_AT_location  (DW_OP_fbreg -112)

// ffffffff81c87070 <__tipc_sendmsg>:
// 0xffffffff81c87070: CFA=RSP+8: RIP=[CFA-8]


// /net/socket.c
// int __sys_getpeername(int fd, struct sockaddr __user *usockaddr,
// 		      int __user *usockaddr_len)
// 1987			err = move_addr_to_user(&address, err, usockaddr,
// 						usockaddr_len);

// ffffffff81a04200 <__sys_getpeername>:
// ...
// ffffffff81a0426f:       78 13                   js     ffffffff81a04284 <__sys_getpeername+0x84>
// ffffffff81a04271:       4c 89 e9                mov    %r13,%rcx
// ffffffff81a04274:       4c 89 e2                mov    %r12,%rdx
// ffffffff81a04277:       48 8d 7c 24 08          lea    0x8(%rsp),%rdi
// ffffffff81a0427c:       e8 6f d9 ff ff          call   ffffffff81a01bf0 <move_addr_to_user>



SEC("kprobe/__tipc_sendmsg")
int BPF_KPROBE(creation) {
    u64 addr = ctx->sp + 0x8 ;
    return 0;
}


// python -c 'print(hex(0xffffffff81a0427c - 0xffffffff81a04200))'
SEC("kprobe/__sys_getpeername+0x7c")
int BPF_KPROBE(use) {
    u64 addr = ctx->sp + 0x8;
    return 0;
}






// =======================================
// python -c 'print(hex(0xffffffff81aa20ce-0xffffffff81aa2090))'
SEC("kprobe/__tipc_sendmsg")
int BPF_KPROBE(prog1)
{
    bpf_printk("__tipc_sendmsg uninitialized struct tipc_socket_addr skaddr;\n");
    return 0;
}



char LICENSE[] SEC("license") = "Dual BSD/GPL";

