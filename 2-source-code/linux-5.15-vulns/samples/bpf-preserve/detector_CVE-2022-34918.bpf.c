#include "vmlinux.h"
#include <bpf/bpf_helpers.h>
#include <bpf/bpf_tracing.h>
#include <bpf/bpf_core_read.h>

// ffffffff81aa2090 <nft_set_elem_init>:
// ffffffff81d577ff <nft_set_elem_init.cold>:


//5339 void *nft_set_elem_init(const struct nft_set *set,
// 			const struct nft_set_ext_tmpl *tmpl,
// 			const u32 *key, const u32 *key_end,
// 			const u32 *data, u64 timeout, u64 expiration, gfp_t gfp)
// {
//5344 	struct nft_set_ext *ext;
//5345 	void *elem;

//5347 	elem = kzalloc(set->ops->elemsize + tmpl->len, gfp);
// ....
//  ext = nft_set_elem_ext(set, elem);
//	nft_set_ext_init(ext, tmpl);
// 5359	if (nft_set_ext_exists(ext, NFT_SET_EXT_DATA)) {      
// 5360		pr_info("[1] nft_set_elem_init  %016lx %016lx %u\n", nft_set_ext_data(ext), data, set->dlen);
// 5361		memcpy(nft_set_ext_data(ext), data, set->dlen);  // out-of-bound !!!! here [0xffffffff81d57881   5361 ]

// ffffffff81aa2090 <nft_set_elem_init>:
// ...
// ffffffff81aa20b2:       48 8b 87 c0 00 00 00    mov    0xc0(%rdi),%rax
// ffffffff81aa20b9:       0f b7 7d 00             movzwl 0x0(%rbp),%edi
// ffffffff81aa20bd:       8b 74 24 48             mov    0x48(%rsp),%esi
// ffffffff81aa20c1:       48 89 0c 24             mov    %rcx,(%rsp)
// ffffffff81aa20c5:       03 78 78                add    0x78(%rax),%edi
// ffffffff81aa20c8:       81 ce 00 01 00 00       or     $0x100,%esi
// ffffffff81aa20ce:       e8 1d 16 83 ff          call   ffffffff812d36f0 <__kmalloc>  // set->ops->elemsize + tmpl->len
// ffffffff81aa20d3:       0f b7 55 00             movzwl 0x0(%rbp),%edx
	
// ffffffff81d577ff <nft_set_elem_init.cold>:
// ...
// ffffffff81d57881:       4c 8b 0c 24             mov    (%rsp),%r9  [ext]
// ffffffff81d57885:       0f b6 8b cb 00 00 00    movzbl 0xcb(%rbx),%ecx  [set->dlen]
// ffffffff81d5788c:       4c 89 e6                mov    %r12,%rsi   [data]
// ffffffff81d5788f:       41 0f b6 41 03          movzbl 0x3(%r9),%eax
// ffffffff81d57894:       4c 01 c8                add    %r9,%rax
// ffffffff81d57897:       48 89 c7                mov    %rax,%rdi [nft_set_ext_data(ext)]
// ffffffff81d5789a:       f3 a4                   rep movsb %ds:(%rsi),%es:(%rdi)

// nft_set_ext_data(ext)： 
// ext
        // [0xffffffff81d57811, 0xffffffff81d57880): DW_OP_reg9 R9
        // [0xffffffff81d57880, 0xffffffff81d5789c): DW_OP_breg7 RSP+0)
// data： [0xffffffff81d577ff, 0xffffffff81d578db): DW_OP_reg12 R12: %r12
// set: [0xffffffff81d577ff, 0xffffffff81d578d8): DW_OP_reg3 RBX
// set->dlen：0xcb(%rbx)
// set->ops: 0xc0(%rbx)
// set->ops->elemsize: 0x78 + [0xc0(%rbx)][%rax]

// tmpl    [0xffffffff81d577ff, 0xffffffff81d578d9): DW_OP_reg6 RBP
// tmpl->len (%rbp)

// python -c 'print(hex(0xffffffff81aa20ce-0xffffffff81aa2090))'
SEC("kprobe/nft_set_elem_init+0x3e")
int BPF_KPROBE(prog1)
{
    u64 rdi = ctx->di;
    u64 rsi = ctx->si;
    u64 rbp = ctx->bp;
    u64 tmpl_len = 0;
    bpf_core_read(&tmpl_len, 8, rbp);

    u64 set_ops_elemsize = 0;
    u64 set_ops_elemsize_addr = ctx->ax + 0x78;
    bpf_core_read(&set_ops_elemsize, 8, set_ops_elemsize_addr);

    u32 sum = (u32) (set_ops_elemsize + tmpl_len);
    bpf_printk("param: set->ops->elemsize:0x%lx, tmpl->len:0x%lx\n", set_ops_elemsize, tmpl_len);
    bpf_printk("param: sum: 0x%x\n", sum);
    bpf_printk("kzalloc:  rdi:0x%lx, rsi:0x%lx\n", rdi, rsi);
    return 0;
}

// python -c 'print(hex(0xffffffff81aa20d3-0xffffffff81aa2090))'
SEC("kprobe/nft_set_elem_init+0x43")
int BPF_KRETPROBE(prog2)
{
    u64 rax = ctx->ax;
    bpf_printk("kzalloc ret:0x%lx\n", rax);
    return 0;
}


// python -c 'print(hex(0xffffffff81d5789a-0xffffffff81d577ff))'
SEC("kprobe/nft_set_elem_init.cold+0x9b")
int BPF_KPROBE(prog3)
{
    u64 dst = ctx->di;
    u64 src = ctx->si;
    u64 len = ctx->cx;
    u64 dst_start_addr = bpf_get_slab_start(dst);
    u64 objlen = bpf_get_buff_len(dst);
    
    bpf_printk("memcpy dst:0x%lx, src:0x%lx\n", dst, src);
    bpf_printk("memcpy dst: start:0x%lx len:0x%lx  objlen:0x%lx\n", dst_start_addr, len, objlen);
    u64 t1 = (dst + len);
    // very weird here, cannot add a u64 objlen ?????????
    u64 t2 = (dst_start_addr + (u32)objlen);
    int oob = t1 > t2;
    bpf_printk("memcpy oob: 0x%lx, 0x%lx, %d\n", t1, t2, oob);
    return 0;
}

// SEC("kretprobe/nft_parse_register_load")
// int BPF_KRETPROBE(prog2)
// {
//     u64 ret = ctx->ax;
//     bpf_printk("nft_parse_register_load ret:0x%lx\n", ret);
//     return 0;
// }


// 0x0f3cf0e9:   DW_TAG_structure_type
//                 DW_AT_name      ("nft_set")
//                 DW_AT_byte_size (0x0100)
//                 DW_AT_alignment (0x40)
//                 DW_AT_decl_file ("/root/linux-5.15/./include/net/netfilter/nf_tables.h")
//                 DW_AT_decl_line (497)
//                 DW_AT_decl_column       (0x08)
//                 DW_AT_sibling   (0x0f3cf298)

// 0x0f3cf250:     DW_TAG_member
//                   DW_AT_name    ("dlen")
//                   DW_AT_decl_file       ("/root/linux-5.15/./include/net/netfilter/nf_tables.h")
//                   DW_AT_decl_line       (523)
//                   DW_AT_decl_column     (0x08)
//                   DW_AT_type    (0x0f3b209a "u8")
//                   DW_AT_data_member_location    (0xcb)



// 0x0f3f250d:   DW_TAG_structure_type
//                 DW_AT_name      ("nft_set_ext_tmpl")
//                 DW_AT_byte_size (0x0c)
//                 DW_AT_decl_file ("/root/linux-5.15/./include/net/netfilter/nf_tables.h")
//                 DW_AT_decl_line (631)
//                 DW_AT_decl_column       (0x08)
//                 DW_AT_sibling   (0x0f3f2538)

// 0x0f3f251b:     DW_TAG_member
//                   DW_AT_name    ("len")
//                   DW_AT_decl_file       ("/root/linux-5.15/./include/net/netfilter/nf_tables.h")
//                   DW_AT_decl_line       (632)
//                   DW_AT_decl_column     (0x06)
//                   DW_AT_type    (0x0f3d1ada "u16")
//                   DW_AT_data_member_location    (0x00)


char LICENSE[] SEC("license") = "Dual BSD/GPL";

